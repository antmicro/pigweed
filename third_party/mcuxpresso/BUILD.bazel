# Copyright 2023 The Pigweed Authors
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may not
# use this file except in compliance with the License. You may obtain a copy of
# the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under
# the License.
load("@pigweed//third_party/mcuxpresso:mcuxpresso_sdk.bzl", "mcuxpresso_sdk")

package(default_visibility = ["//visibility:public"])

licenses(["notice"])

cc_library(
    name = "default_mcuxpresso_sdk",
    # The "default" config is not compatible with any configuration: you can't
    # build MCUXpresso targets without choosing an SDK.
    target_compatible_with = ["@platforms//:incompatible"],
)

cc_library(
    name = "conf",
    defines = [
        "CPU_MIMXRT595SFFOC_cm33",
        "SERIAL_PORT_TYPE_UART=1",
        "CFG_BLE=\"\"",
        "BOOT_HEADER_ENABLE=1",
        "LFS_NO_INTRINSICS=1",
        "LFS_NO_ERROR=1",
        "FSL_OSA_TASK_ENABLE=1",
        "FSL_OSA_MAIN_FUNC_ENABLE=0",
        "LOG_ENABLE_ASYNC_MODE=1",
        "LOG_MAX_ARGUMENT_COUNT=10",
        "LOG_ENABLE_OVERWRITE=0",
        "SDIO_ENABLED=",
        "CONFIG_ARM=1",
        "DEBUG_CONSOLE_TRANSFER_NON_BLOCKING=1",
        "SERIAL_PORT_TYPE_UART=1",
        "MBEDTLS_CONFIG_FILE=\\\"ksdk_mbedtls_config.h\\\"",
        "DEBUG_CONSOLE_DISABLE_RTOS_SYNCHRONIZATION",
        "FSL_RTOS_FREE_RTOS",
        "FSL_SDK_DRIVER_QUICK_ACCESS_ENABLE=1",
        "SDK_DEBUGCONSOLE=1",
        "SDK_OS_FREE_RTOS",
        "PW_FUNCTION_ENABLE_DYNAMIC_ALLOCATION",
        "__STDC_FORMAT_MACROS",
        "_GLIBCXX_HAVE_INTTYPES_H",
        "__int64_t_defined",
        # USB config
        "USB_STACK_USE_DEDICATED_RAM=1",
        "FSL_OSA_BM_TASK_ENABLE=0",
        "FSL_OSA_BM_TIMER_CONFIG=0",
    ],
    includes = ["."],
    hdrs = [
        "ffconf.h",
        "usb_host_config.h",
        "wifi_config.h",
        "wifi_bt_module_config.h",
        "sdmmc_config.h",
        "clock_config.h",
        "board.h",
        "wifi_bt_config.h",
        "edgefast_bluetooth_config.h",
        "peripherals.h",
        "pin_mux.h",
    ],
)

cc_library(
    name = "include_header",
    includes = ["."],
    hdrs = [
        "app_bluetooth_config.h",
    ],
)

exports_files(["app_bluetooth_config.h"])

mcuxpresso_sdk(
    name = "mcuxpresso_sdk",
    manifest = "manifests/EVK-MIMXRT595_manifest_v3_14.xml",
    include = [
        "component.serial_manager_uart.MIMXRT595S",
        "platform.drivers.flexcomm_i2c.MIMXRT595S",
        "platform.drivers.flexcomm_spi.MIMXRT595S",
        "platform.drivers.flexcomm_usart_dma.MIMXRT595S",
        "platform.drivers.flexcomm_usart_freertos.MIMXRT595S",
        "platform.drivers.flexio_spi.MIMXRT595S",
        "platform.drivers.inputmux.MIMXRT595S",
        "platform.drivers.lpc_dma.MIMXRT595S",
        "platform.drivers.lpc_gpio.MIMXRT595S",
        "platform.drivers.lpc_iopctl.MIMXRT595S",
        "platform.drivers.flexspi.MIMXRT595S",
        "platform.drivers.mu.MIMXRT595S",
        "platform.drivers.pint.MIMXRT595S",
        "platform.drivers.power.MIMXRT595S",
        "platform.drivers.common.MIMXRT595S",
        "platform.drivers.cache_cache64.MIMXRT595S",
        "platform.drivers.flash_config.evkmimxrt595.MIMXRT595S",
        "utility.debug_console.MIMXRT595S",
        "device.MIMXRT595S_CMSIS.MIMXRT595S",
        "middleware.wifi.fwdnld_intf_abs.MIMXRT595S",
        "middleware.edgefast_bluetooth.wifi_nxp.controller.base.MIMXRT595S",
        "middleware.edgefast_bluetooth.ble.ethermind.cm33.MIMXRT595S",
        "middleware.usb.device_controller_ip3511hs.MIMXRT595S",
        "middleware.usb.phy.MIMXRT595S",
        "middleware.usb.device.controller.driver.MIMXRT595S",
        "middleware.usb.device.ip3511hs_config_header.MIMXRT595S",
        "middleware.usb.device.common_header.MIMXRT595S",
        "middleware.usb.common_header.MIMXRT595S",
    ],
    exclude = [
        "device.MIMXRT595S_startup.MIMXRT595S",
        "component.osa.MIMXRT595S",
        "middleware.sdmmc.sdhc.template.MIMXRT595S",
        "middleware.sdmmc.sdif.template.MIMXRT595S",
        "middleware.sdmmc.usdhc.template.MIMXRT595S",
        "middleware.wifi.wifi_bt_config.template.MIMXRT595S",
        "middleware.fatfs.template_usb.MIMXRT595S",
        "component.wifi_bt_module.config.MIMXRT595S",
        "middleware.edgefast_bluetooth.config.template.MIMXRT595S",
        "middleware.usb.host.ip3516hs_config_header.MIMXRT595S",
        "middleware.lwip.template.MIMXRT595S",
        "middleware.edgefast_bluetooth.template.MIMXRT595S",
        "middleware.wifi.template.MIMXRT595S",
        "project_template.evkmimxrt595.MIMXRT595S",
        "project_template.MIMXRT595S.MIMXRT595S",
        "middleware.freertos-kernel.MIMXRT595S",
        "middleware.freertos-kernel.heap_4.MIMXRT595S",
        "platform.utilities.misc_utilities.MIMXRT595S",
    ],
    includes = [
        "core/drivers/common",
        "core/drivers/flexcomm/usart",
        "core/devices/MIMXRT595S",
        "core/devices/MIMXRT595S/drivers",
        "core/CMSIS/Core/Include",
        "core/drivers/lpc_gpio",
        "core/utilities/debug_console",
        "core/components/serial_manager",
        "core/components/uart",
        "middleware/edgefast_bluetooth/include",
        "middleware/wireless/ethermind/port/pal/mcux/bluetooth/controller",
        "middleware/usb/phy",
        "middleware/usb/host",
        "middleware/usb/include",
        "core/components/osa/",
        "core/components/lists",
        "middleware/edgefast_bluetooth/source/porting",
        "core/drivers/lpc_iopctl",
        "core/drivers/flexspi",
        "core/drivers/cache/cache64",
        "middleware/sdmmc/sdio",
        "middleware/sdmmc/common",
        "middleware/sdmmc/host/usdhc",
        "middleware/sdmmc/osa",
        "core/drivers/usdhc",
        "core/components/gpio",
        "middleware/usb/device",
    ],
    libraries = [
        "middleware/wireless/ethermind/bluetooth/private/lib/mcux/default/ble/cm33/gcc/libethermind_ble_core.a",
        "middleware/wireless/ethermind/bluetooth/private/lib/mcux/default/ble/cm33/gcc/libethermind_ble_gatt.a",
        "middleware/wireless/ethermind/bluetooth/private/lib/mcux/default/ble/cm33/gcc/libethermind_ble_protocol.a",
        "middleware/wireless/ethermind/bluetooth/private/lib/mcux/default/ble/cm33/gcc/libethermind_ble_util.a",
        "middleware/wireless/ethermind/bluetooth/private/lib/mcux/default/ble/cm33/gcc/libethermind_ble_ga.a",
    ],
    device_core = "cm33_MIMXRT595S",
    deps = [
        ":conf",
        "@pigweed//targets/mimxrt595_evk_freertos:freertos_config",
        "@freertos",
    ],
    include_headers = [
        ":include_header",
    ],
)

